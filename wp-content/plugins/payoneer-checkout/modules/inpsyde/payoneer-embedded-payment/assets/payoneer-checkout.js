!function(){"use strict";var e={20:function(e,t,o){var n=o(609),a=Symbol.for("react.element"),r=(Symbol.for("react.fragment"),Object.prototype.hasOwnProperty),s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};t.jsx=function(e,t,o){var n,i={},d=null,l=null;for(n in void 0!==o&&(d=""+o),void 0!==t.key&&(d=""+t.key),void 0!==t.ref&&(l=t.ref),t)r.call(t,n)&&!c.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:a,type:e,key:d,ref:l,props:i,_owner:s.current}}},609:function(e){e.exports=window.React},848:function(e,t,o){e.exports=o(20)}},t={};function o(n){var a=t[n];if(void 0!==a)return a.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,o),r.exports}o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,{a:t}),t},o.d=function(e,t){for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};o.r(n),o.d(n,{addComponent:function(){return T},initPayoneerComponents:function(){return v},mountComponents:function(){return D},onBeforeError:function(){return P},onComponentListChange:function(){return N},onPaymentDeclined:function(){return C},onValidationInfo:function(){return L},pay:function(){return O},reboot:function(){return I},removeComponent:function(){return k},setActivePaymentMethod:function(){return M},setEnv:function(){return g},setForceHostedFlow:function(){return A},setIsValid:function(){return b},setLongId:function(){return h},setSdkState:function(){return f}});var a={};o.r(a),o.d(a,{getEnv:function(){return U},getExtensionData:function(){return x},getLongId:function(){return K},getSdk:function(){return H},getSdkIntegrity:function(){return Y},getSdkVersion:function(){return j}});var r=window.jQuery,s=o.n(r);const{paymentFieldsComponentAttribute:c}=window.PayoneerData,i=()=>document.querySelector('.woocommerce-checkout input[name="payment_method"]:checked')?.id,d=()=>{return e=i(),/^payment_method_payoneer-(checkout|afterpay)/i.test(e);var e},l=()=>"1"===window.PayoneerData.isPayForOrder;var p=window.wp.data;const u={SET_EXTENSION_DATA:"SET_EXTENSION_DATA",SET_LONG_ID:"SET_LONG_ID",SET_LIST_URL:"SET_LIST_URL",SET_ENV:"SET_ENV",SET_SDK:"SET_SDK",SET_SDK_VERSION:"SET_SDK_VERSION",SET_SDK_INTEGRITY:"SET_SDK_INTEGRITY",SET_SDK_STATE:"SET_SDK_STATE",ADD_COMPONENT:"ADD_COMPONENT",REMOVE_COMPONENT:"REMOVE_COMPONENT",MOUNT_COMPONENTS:"MOUNT_COMPONENTS",PAY:"PAY",SET_ACTIVE_PAYMENT_METHOD:"SET_ACTIVE_PAYMENT_METHOD",SET_FORCE_HOSTED_FLOW:"SET_FORCE_HOSTED_FLOW",SET_IS_VALID:"SET_IS_VALID"},y={activePaymentMethod:"",longId:null,env:null,sdkState:"UNINITIALIZED",forceHostedFlow:!0,isValid:!1,availableDropInComponents:[]};const S=e=>({"payoneer-checkout":"cards","payoneer-afterpay":"afterpay"}[e]),{paymentFieldsComponentAttribute:E}=window.PayoneerData,m=(e,t)=>{for(const[o,n]of Object.entries(e)){const e=_(o);e instanceof Element&&t.isAvailable(o)&&n.mount(e)}},_=function(e){return document.querySelector(`[${E}=${e}]`)};var w=window.wp.hooks;const h=e=>async({select:t,resolveSelect:o,dispatch:n})=>{const a=await o.getSdk();await a.updateLongId(e),n({type:u.SET_LONG_ID,payload:e})},f=e=>({type:u.SET_SDK_STATE,payload:e});function g(e){return{type:u.SET_ENV,payload:e}}const T=e=>async({select:t,resolveSelect:o,dispatch:n})=>{const a=await o.getSdk();if(console.log(a),!a.isDroppedIn(e)&&"object"==typeof _(e))try{const t={name:e,component:a.dropIn(e,{hidePaymentButton:!0})};console.log("New component",t),n({type:u.ADD_COMPONENT,payload:t}),m({[t.name]:t.component},a)}catch(t){console.error(`Failed to drop in component ${e}. Error details: ${t}`)}};function k(e){return{type:u.REMOVE_COMPONENT,payload:e}}const v=()=>async({select:e,resolveSelect:t,dispatch:o})=>{const n=await t.getSdk(),a=await t.getLongId();await n.updateLongId(a),await o.mountComponents()},I=()=>async({select:e,resolveSelect:t,dispatch:o})=>{w.defaultHooks.doAction("payoneer.webSdk.reboot"),wp.data.dispatch("wc/store/cart").invalidateResolutionForStore(),o.invalidateResolutionForStore(),await o.mountComponents()},D=()=>async({select:e,resolveSelect:t,dispatch:o})=>{const n=await t.getSdk(),a=e.getAvailableDropInComponents();console.log("Mounting components",a),m(a,n)},O=()=>({select:e,dispatch:t})=>{const o=e.getAvailableDropInComponents(),n=e.getActivePaymentMethod(),a=o[S(n)];a?a.pay():console.log("Component not found.")},P=(e,t,o)=>async({select:n,dispatch:a})=>(a.setSdkState(e.state),console.error("WebSDK error:",{sdk:e,component:t,data:o}),["SYSTEM_FAILURE"].includes(o?.interaction?.reason)?(a.setForceHostedFlow(!0),!0):w.defaultHooks.applyFilters("payoneer.webSdk.onSdkError",!1,e,t,o)),C=(e,t,o)=>async({select:n,dispatch:a})=>w.defaultHooks.applyFilters("payoneer.webSdk.onPaymentDeclined",!0,e,t,o),N=(e,t)=>async({select:o,dispatch:n})=>{console.log("onComponentListChange",e,t),t.addedComponents.forEach((e=>{n.addComponent(e)})),t.removedComponents.forEach((e=>{n.removeComponent(e)}))},L=(e,t,o)=>async({select:e,dispatch:n})=>{console.log(t,o),n.setIsValid(o.valid)},M=e=>async({dispatch:t})=>{console.log("Setting active payment method",e),t.mountComponents(),t({type:u.SET_ACTIVE_PAYMENT_METHOD,payload:e})};function A(e){return console.log("Setting hosted flow override flag",e),{type:u.SET_FORCE_HOSTED_FLOW,payload:e}}function b(e){return{type:u.SET_IS_VALID,payload:e}}var R=window.wp.apiFetch,F=o.n(R);const{websdkStyles:V}=PayoneerData,H=()=>async({resolveSelect:e,dispatch:t})=>{const o=await e.getEnv(),n=await e.getSdkVersion(),a=await e.getSdkIntegrity(),r=await e.getLongId(),s=await(c={env:o,sdkVersion:n,sdkIntegrity:a,onBeforeError:async(e,o,n)=>await t.onBeforeError(e,o,n),onPaymentDeclined:async(e,o,n)=>await t.onPaymentDeclined(e,o,n),onComponentListChange:async(e,o)=>await t.onComponentListChange(e,o),onValidationInfo:async(e,o,n)=>await t.onValidationInfo(e,o,n),preload:["cards"],styles:V},window.Payoneer?.CheckoutWeb?window.Payoneer.CheckoutWeb(c):new Promise(((e,t)=>{const o=document.createElement("script");o.src=((e,t)=>{const o=t?`-${t}`:"";return new URL(window.PayoneerData.webSdkUmdUrlTemplate?.replace("<env>",e)?.replace("<version>",o))})(c.env,c.sdkVersion),o.onload=e,o.onerror=t,c.sdkVersion&&c.sdkIntegrity&&(o.integrity=c.sdkIntegrity,o.crossOrigin="anonymous"),document.head.appendChild(o)})).then((()=>window.Payoneer.CheckoutWeb(c))));var c;if("LOADING"===s.state){const e=async()=>await new Promise((e=>{const t=setInterval((()=>{"LOADING"!==s.state&&(e(s.state),clearInterval(t))}),1e3)}));await e()}await s.updateLongId(r),await t.setForceHostedFlow(!1),await t.setSdkState(s.state),await t({type:u.SET_SDK,payload:s})},x=()=>async({dispatch:e})=>{const t=await F()({path:"/wc/store/v1/cart#skipPreloadingMiddleware",method:"GET",cache:"no-store",parse:!1}),o=(await t.json()).extensions["payoneer-checkout"];console.log("Payoneer Extension Data: ",o),await e({type:u.SET_EXTENSION_DATA,payload:o}),w.defaultHooks.doAction("payoneer.checkout.onReceiveExtensionData",o)},K=()=>async({resolveSelect:e,dispatch:t})=>{const o=await e.getExtensionData();await t({type:u.SET_LONG_ID,payload:o.longId})},U=()=>async({resolveSelect:e,dispatch:t})=>{const o=await e.getExtensionData();await t({type:u.SET_ENV,payload:o.environment})},j=()=>async({resolveSelect:e,dispatch:t})=>{const o=await e.getExtensionData();await t({type:u.SET_SDK_VERSION,payload:o.sdkVersion})},Y=()=>async({resolveSelect:e,dispatch:t})=>{const o=await e.getExtensionData();await t({type:u.SET_SDK_INTEGRITY,payload:o.sdkIntegrity})};const G="payoneer-checkout",q=(0,p.createReduxStore)(G,{reducer:(e=y,t)=>{switch(t.type){case u.SET_EXTENSION_DATA:return{...e,extension:t.payload};case u.SET_LONG_ID:return{...e,longId:t.payload};case u.SET_LIST_URL:return{...e,listUrl:t.payload};case u.SET_ENV:return{...e,env:t.payload};case u.SET_SDK:return{...e,sdk:t.payload};case u.SET_SDK_VERSION:return{...e,sdkVersion:t.payload};case u.SET_SDK_INTEGRITY:return{...e,sdkIntegrity:t.payload};case u.SET_SDK_STATE:return{...e,sdkState:t.payload};case u.SET_ACTIVE_PAYMENT_METHOD:return{...e,activePaymentMethod:t.payload};case u.SET_FORCE_HOSTED_FLOW:return{...e,forceHostedFlow:t.payload};case u.SET_IS_VALID:return{...e,isValid:t.payload};case u.ADD_COMPONENT:return{...e,availableDropInComponents:{...e.availableDropInComponents,[t.payload.name]:t.payload.component}};case u.REMOVE_COMPONENT:let o={...e.availableDropInComponents};return delete o[t.payload.name],{...e,availableDropInComponents:o};default:return e}},actions:n,selectors:{getExtensionData:e=>e.extension,getLongId:e=>e.longId,getEnv:e=>e.env,getSdkVersion:e=>e.sdkVersion,getSdkIntegrity:e=>e.sdkIntegrity,getSdk:e=>e.sdk,isHostedModeForced:e=>e.forceHostedFlow,getIsValid:e=>"payoneer-checkout"!==e.activePaymentMethod||e.isValid,getActivePaymentMethod:e=>e.activePaymentMethod,getAvailableDropInComponents:e=>e.availableDropInComponents},resolvers:a});(0,p.register)(q);const W="x-payoneer-checkout-force-hosted-flow",X="x-payoneer-is-payment-checkout",$=()=>{const e={[W]:String((0,p.select)(G).isHostedModeForced()),[X]:l&&new URLSearchParams(window.location.search).get("key")||""};return w.defaultHooks.applyFilters("payoneer.http.customHeaders",e)};w.defaultHooks.addAction("payoneer.checkout.onReceiveExtensionData","payoneer/setupCustomHttpHeaders",(()=>{w.defaultHooks.addFilter("payoneer.http.customHeaders","payoneer/setupCustomHttpHeaders",(function(e){return e["x-payoneer-long-id"]=String((0,p.select)(G).getLongId()),e}))}));var B=window.wc.wcBlocksData;const Q=()=>{const e=function(){const e=document.querySelector('.woocommerce-checkout input[name="payment_method"]:checked').value;(0,p.dispatch)(G).setActivePaymentMethod(e)};jQuery(document.body).on("payment_method_selected",e),e()};var z=o(609),Z=o(848);const J=()=>(0,p.dispatch)(G).initPayoneerComponents(),ee=()=>(0,p.dispatch)(G).pay(),te=()=>(0,p.dispatch)(G).reboot(),oe=(0,p.withSelect)(((e,t)=>{const o=e(G),{activePaymentMethod:n,eventRegistration:a}=t;return{activePaymentMethod:n,eventRegistration:a,payWithPayoneer:ee,initPayoneerComponents:J,rebootPayoneer:te,isValid:o.getIsValid()}}))((function({payWithPayoneer:e,initPayoneerComponents:t,paymentMethodData:o,rebootPayoneer:n,activePaymentMethod:a,eventRegistration:r,isValid:s}){const{onPaymentSetup:c,onCheckoutSuccess:i,onCheckoutFail:d}=r;(0,z.useEffect)((()=>{t()}),[]),(0,z.useEffect)((()=>i((()=>{e()}))),[]),(0,z.useEffect)((()=>d(n)),[]),(0,z.useEffect)((()=>c((()=>s?{type:"success"}:{type:"failure",message:"Invalid payment fields"}))),[s,c,o]);const l=S(a);return(0,Z.jsx)("div",{className:`payment_method_${a}`,"data-component":l})})),ne=(0,p.select)(G);document.addEventListener("DOMContentLoaded",(()=>{wp.hooks.addFilter("payoneer.webSdk.onPaymentDeclined","payoneer/blockCheckout",(()=>(window.location.reload(),!0)))}),!1);document.addEventListener("DOMContentLoaded",(async()=>{const e=window.fetch;if(window.fetch=async(...t)=>{let[o,n]=t;if(new URL(o,window.location.origin).origin!==window.location.origin)return e(o,n);const a=$();return console.log("Adding custom headers to fetch call",a),n=n&&n.headers?{...n,headers:{...n.headers,...a}}:{...n,headers:a},await e(o,n)},!window.XMLHttpRequest)return;const t=XMLHttpRequest.prototype.open,o=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(e,o,...n){this._isSameOrigin=new URL(o,window.location.origin).origin===window.location.origin,t.apply(this,[e,o,...n])},XMLHttpRequest.prototype.send=function(...e){const t=$();if(this._isSameOrigin){console.log("Adding custom headers to XMLHttpRequest call",t);for(const[e,o]of Object.entries(t))this.setRequestHeader(e,o)}o.apply(this,e)}}),!1),l()?(console.log("Loading payment checkout integration"),document.addEventListener("DOMContentLoaded",(()=>{Q();const e=s()("#order_review");w.defaultHooks.addFilter("payoneer.webSdk.onSdkError","payoneer/paymentCheckout",((e,t,o,n)=>{const{payOrderErrorFlag:a}=window.PayoneerData,r=new URL(document.location);return r.searchParams.set(a,!0),window.location.href=r.toString(),e})),e.on("submit",(t=>{var o;d()&&!(0,p.select)(G).isHostedModeForced()&&(t.preventDefault(),t.stopImmediatePropagation(),(o=e,o.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),s().ajax({type:"POST",url:window.wc_checkout_params.ajax_url,xhrFields:{withCredentials:!0},dataType:"json",data:{action:"payoneer_order_pay",fields:o.serialize(),params:new URL(document.location).searchParams.toString()}}).always((()=>o.unblock()))).then((()=>(0,p.dispatch)(G).pay())).catch((()=>{window.scrollTo(0,0),window.location.reload()})))})),(0,p.dispatch)(G).mountComponents()}),!1)):"1"===window?.PayoneerData?.isBlockCheckout?(console.log("Loading classic checkout integration"),(()=>{let e;const t=(0,p.select)(B.PAYMENT_STORE_KEY),o=()=>{const o=t.getActivePaymentMethod();e!==o&&((0,p.dispatch)(G).setActivePaymentMethod(o),e=o)};(0,p.subscribe)(o,B.PAYMENT_STORE_KEY),o()})(),Array.isArray(inpsydeGateways)?inpsydeGateways.forEach((e=>{var t;t=e,wp.hooks.addFilter(`${t}_checkout_fields`,t,(e=>(e.push(oe),e))),wp.hooks.addFilter("payoneer-checkout_payment_method_icons","payoneer-checkout",(e=>"payoneer-checkout"===ne.getActivePaymentMethod()?[]:e))})):console.error("window.inpsydeGateways not found")):(console.log("Loading classic checkout integration"),document.addEventListener("DOMContentLoaded",(()=>{Q();const e=s()("form.checkout");w.defaultHooks.addFilter("payoneer.webSdk.onSdkError","payoneer/shortcodeCheckout",((e,t,o,n)=>(wp.data.dispatch(G).reboot(),s()(document.body).trigger("update_checkout"),e))),s()(document.body).on("updated_checkout",(()=>(0,p.dispatch)(G).initPayoneerComponents())),e.on("checkout_place_order_success",((t,o)=>{if(d()&&!(0,p.select)(G).isHostedModeForced())return(0,p.dispatch)(G).pay(),o.redirect="#payoneer-redirect",setTimeout((()=>{e.removeClass("processing").unblock(),s().scroll_to_notices(s()((e=>{const t=".payment_box."+e;return document.querySelector(t)})(i())))}),1500),!1}))}),!1))}();
//# sourceMappingURL=payoneer-checkout.js.map